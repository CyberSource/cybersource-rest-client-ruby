require 'openssl'
require 'base64'
require_relative '../util/Constants.rb'

public

  class Utility
    def getResponseCodeMessage(responseCode)
      responseCode = responseCode.to_s
      case responseCode
      when "200"
        tempResponseCodeMessage = "Transcation Successful"
      when "201"
        tempResponseCodeMessage = "Transcation Successful"
      when "400"
        tempResponseCodeMessage = "Bad Request"
      when "401"
        tempResponseCodeMessage = "Authentication Failed"
      when "404"
        tempResponseCodeMessage = "Not Found"
      when "403"
        tempResponseCodeMessage = "Forbidden"
      when "500"
        tempResponseCodeMessage = "Internal Server Error"
      when "502"
        tempResponseCodeMessage = "Bad Gateway"
      when "503"
        tempResponseCodeMessage = "Service Unavailable"
      when "504"
        tempResponseCodeMessage = "Gateway Timeout"
      else
        tempResponseCodeMessage= ''
      end
      return tempResponseCodeMessage
    end

    def self.getCertificateBasedOnKeyAlias(certificateList, keyAlias)
      return nil if certificateList.nil?

      certificateList.find do |cert|
        cert.subject.to_a.any? { |_, value, _| value.include?(keyAlias) }
      end
    end

    def self.getCertificateCollectionAndPrivateKeyFromP12(certificateFilePath, keyPass)
      p12File = File.binread(certificateFilePath)
      p12Object = OpenSSL::PKCS12.new(p12File, keyPass)

      privateKey = OpenSSL::PKey::RSA.new(p12Object.key)

      primaryX5Certificate = p12Object.certificate
      additionalX5Certificates = p12Object.ca_certs

      certificateList = [primaryX5Certificate]
      certificateList.concat(additionalX5Certificates) if additionalX5Certificates

      return [privateKey, certificateList]
    end

    def self.isP12GeneratedByCyberSource(filePath, password, logger = nil)
      begin
        _, certificateList = getCertificateCollectionAndPrivateKeyFromP12(filePath, password)

        foundCertificate = getCertificateBasedOnKeyAlias(certificateList, Constants::DEFAULT_ALIAS_FOR_MLE_CERT)

        return !foundCertificate.nil?
      rescue => e
        logger&.error("Error while checking if P12 is generated by CyberSource: #{e.message}")
        return false
      end
    end
  end
